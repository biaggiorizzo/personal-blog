<script type="module">
  // Só roda em páginas de conteúdo (não listas) e se houver Mermaid
  const isList = document.body.classList.contains('list'); // home/section/archives/search
  const hasMermaid = !!document.querySelector('.mermaid');
  if (isList || !hasMermaid) {
    // Nada pra fazer
  } else {
    const isDark = () =>
      document.documentElement.classList.contains('dark') ||
      document.body.classList.contains('dark') ||
      localStorage.getItem('pref-theme') === 'dark';

    // Importa Mermaid ESM v11
    const { default: mermaid } =
      await import('https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs');

    // Transforma <div class="mermaid"> em hosts persistentes
    function setupHosts() {
      const hosts = [];
      document.querySelectorAll('.mermaid').forEach((el) => {
        const code = el.textContent || '';
        const host = document.createElement('div');
        host.className = 'mermaid-host';
        host.dataset.code = code;
        el.replaceWith(host);
        hosts.push(host);
      });
      return hosts;
    }

    async function renderAll() {
      mermaid.initialize({
        startOnLoad: false,
        theme: isDark() ? 'dark' : 'default',
        themeVariables: { background: 'transparent' },
        // securityLevel: 'loose', // habilite se precisar de HTML no diagrama
      });

      const hosts = document.querySelectorAll('.mermaid-host');
      let i = 0;
      for (const host of hosts) {
        const code = (host.dataset.code || '').trim();
        try {
          const { svg } = await mermaid.render(`m-${i++}`, code);
          host.innerHTML = svg;
        } catch (e) {
          console.error('Mermaid render error:', e, '\nCode:\n', code);
        }
      }
    }

    // Bootstrap
    const boot = () => { setupHosts(); renderAll(); };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }

    // Re-render quando o tema muda (PaperMod altera classe no <html>)
    const mo = new MutationObserver(() => renderAll());
    mo.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

    // E no clique do botão, se existir
    document.getElementById('theme-toggle')?.addEventListener('click', () => {
      setTimeout(renderAll, 0);
    });
  }
</script>
